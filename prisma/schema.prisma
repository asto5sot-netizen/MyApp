generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Profile {
  id                   String         @id @default(uuid())
  email                String         @unique
  role                 Role           @default(client)
  full_name            String
  phone                String?        @unique
  avatar_url           String?
  preferred_language   String         @default("en")
  is_verified          Boolean        @default(false)
  city                 String         @default("Bangkok")
  created_at           DateTime       @default(now())
  updated_at           DateTime       @updatedAt

  client_conversations Conversation[] @relation("ClientConversations")
  pro_conversations    Conversation[] @relation("ProConversations")
  jobs                 Job[]          @relation("ClientJobs")
  sent_messages        Message[]
  notifications        Notification[]
  pro_profile          ProProfile?
  proposals            Proposal[]     @relation("ProProposals")
  reviews_received     Review[]       @relation("ReviewsReceived")
  reviews_given        Review[]       @relation("ReviewsGiven")

  @@map("profiles")
}

model ProProfile {
  id                  String             @id @default(uuid())
  profile_id          String             @unique
  bio                 String?
  bio_translated      Json?
  experience_years    Int                @default(0)
  hourly_rate         Decimal?           @db.Decimal(10, 2)
  service_radius_km   Int                @default(20)
  rating              Decimal            @default(0) @db.Decimal(3, 2)
  reviews_count       Int                @default(0)
  completed_jobs      Int                @default(0)
  is_available        Boolean            @default(true)
  location_lat        Decimal?           @db.Decimal(10, 8)
  location_lng        Decimal?           @db.Decimal(11, 8)
  city                String             @default("Bangkok")
  verification_status VerificationStatus @default(pending)
  whatsapp            String?
  telegram            String?
  line_id             String?
  facebook            String?
  instagram           String?
  tiktok              String?
  youtube             String?
  website             String?
  categories          ProCategory[]
  photos              ProPhoto[]
  profile             Profile            @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@map("pro_profiles")
}

model Category {
  id             String        @id @default(uuid())
  slug           String        @unique
  name_th        String
  name_en        String
  name_ru        String
  icon_url       String?
  parent_id      String?
  is_active      Boolean       @default(true)
  sort_order     Int           @default(0)
  parent         Category?     @relation("CategoryChildren", fields: [parent_id], references: [id])
  children       Category[]    @relation("CategoryChildren")
  jobs           Job[]
  pro_categories ProCategory[]

  @@map("categories")
}

model Job {
  id                     String         @id @default(uuid())
  client_id              String
  category_id            String
  title                  String
  description            String
  original_language      String         @default("en")
  title_translated       Json?
  description_translated Json?
  budget_min             Decimal?       @db.Decimal(10, 2)
  budget_max             Decimal?       @db.Decimal(10, 2)
  location_address       String?
  location_lat           Decimal?       @db.Decimal(10, 8)
  location_lng           Decimal?       @db.Decimal(11, 8)
  district               String?
  city                   String         @default("Bangkok")
  preferred_date         DateTime?
  status                 JobStatus      @default(open)
  proposals_count        Int            @default(0)
  created_at             DateTime       @default(now())
  expires_at             DateTime?
  conversations          Conversation[]
  category               Category       @relation(fields: [category_id], references: [id])
  client                 Profile        @relation("ClientJobs", fields: [client_id], references: [id])
  proposals              Proposal[]
  reviews                Review[]

  @@map("jobs")
}

model Proposal {
  id                 String         @id @default(uuid())
  job_id             String
  pro_id             String
  message            String
  message_translated Json?
  original_language  String         @default("en")
  price              Decimal        @db.Decimal(10, 2)
  price_type         PriceType      @default(fixed)
  estimated_days     Int?
  status             ProposalStatus @default(pending)
  created_at         DateTime       @default(now())
  job                Job            @relation(fields: [job_id], references: [id], onDelete: Cascade)
  pro                Profile        @relation("ProProposals", fields: [pro_id], references: [id])

  @@unique([job_id, pro_id])
  @@map("proposals")
}

model Conversation {
  id              String    @id @default(uuid())
  job_id          String
  client_id       String
  pro_id          String
  last_message_at DateTime  @default(now())
  is_archived     Boolean   @default(false)
  client          Profile   @relation("ClientConversations", fields: [client_id], references: [id])
  job             Job       @relation(fields: [job_id], references: [id])
  pro             Profile   @relation("ProConversations", fields: [pro_id], references: [id])
  messages        Message[]

  @@unique([job_id, client_id, pro_id])
  @@map("conversations")
}

model Message {
  id                 String       @id @default(uuid())
  conversation_id    String
  sender_id          String
  content            String
  content_translated Json?
  original_language  String       @default("en")
  message_type       MessageType  @default(text)
  attachment_url     String?
  is_read            Boolean      @default(false)
  created_at         DateTime     @default(now())
  conversation       Conversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)
  sender             Profile      @relation(fields: [sender_id], references: [id])

  @@map("messages")
}

model Review {
  id                 String   @id @default(uuid())
  job_id             String
  reviewer_id        String
  pro_id             String
  rating             Int
  comment            String?
  comment_translated Json?
  original_language  String   @default("en")
  is_moderated       Boolean  @default(true)
  created_at         DateTime @default(now())
  job                Job      @relation(fields: [job_id], references: [id])
  pro                Profile  @relation("ReviewsReceived", fields: [pro_id], references: [id])
  reviewer           Profile  @relation("ReviewsGiven", fields: [reviewer_id], references: [id])

  @@unique([job_id, reviewer_id])
  @@map("reviews")
}

model ProCategory {
  pro_id      String
  category_id String
  price_from  Decimal?   @db.Decimal(10, 2)
  description String?
  category    Category   @relation(fields: [category_id], references: [id])
  pro         ProProfile @relation(fields: [pro_id], references: [id], onDelete: Cascade)

  @@id([pro_id, category_id])
  @@map("pro_categories")
}

model ProPhoto {
  id         String     @id @default(uuid())
  pro_id     String
  url        String
  caption    String?
  sort_order Int        @default(0)
  created_at DateTime   @default(now())
  pro        ProProfile @relation(fields: [pro_id], references: [id], onDelete: Cascade)

  @@map("pro_photos")
}

model Notification {
  id         String           @id @default(uuid())
  user_id    String
  type       NotificationType
  title      String
  body       String
  data       Json?
  is_read    Boolean          @default(false)
  created_at DateTime         @default(now())
  user       Profile          @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("notifications")
}

enum Role {
  client
  pro
  admin
}

enum VerificationStatus {
  pending
  verified
  rejected
}

enum JobStatus {
  open
  in_progress
  done
  cancelled
}

enum ProposalStatus {
  pending
  accepted
  rejected
  withdrawn
}

enum PriceType {
  fixed
  per_hour
  negotiable
}

enum MessageType {
  text
  image
  file
}

enum NotificationType {
  new_proposal
  new_message
  job_accepted
  new_review
  email_verified
  proposal_accepted
}
